<!DOCTYPE html>
<html>
<head>
    <title>Navigation Hang Test</title>
    <script src="https://unpkg.com/htmx.org@1.9.0"></script>
</head>
<body>
    <h1>Navigation Test</h1>
    <p>This test will automatically navigate between Users and New User pages to test for hang issues.</p>
    
    <div id="status">Starting test...</div>
    <div id="counter">Navigation count: 0</div>
    <div id="log"></div>
    
    <button id="startTest">Start Automatic Test</button>
    <button id="stopTest">Stop Test</button>
    
    <script>
        let testRunning = false;
        let navigationCount = 0;
        let testInterval = null;
        
        const urls = ['/users', '/users/new'];
        let currentUrlIndex = 0;
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div>${timestamp}: ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(status) {
            document.getElementById('status').textContent = status;
        }
        
        function updateCounter() {
            document.getElementById('counter').textContent = `Navigation count: ${navigationCount}`;
        }
        
        function performNavigation() {
            if (!testRunning) return;
            
            const url = urls[currentUrlIndex];
            navigationCount++;
            updateCounter();
            
            log(`Navigating to: ${url} (count: ${navigationCount})`);
            updateStatus(`Navigating to: ${url}`);
            
            // Perform HTMX request
            htmx.ajax('GET', url, {
                target: 'body',
                swap: 'none'
            }).then(() => {
                log(`Navigation ${navigationCount} completed successfully`);
                updateStatus('Navigation completed');
            }).catch((error) => {
                log(`Navigation ${navigationCount} failed: ${error}`);
                updateStatus('Navigation failed');
                stopTest();
            });
            
            // Switch to next URL
            currentUrlIndex = (currentUrlIndex + 1) % urls.length;
        }
        
        function startTest() {
            if (testRunning) return;
            
            testRunning = true;
            navigationCount = 0;
            currentUrlIndex = 0;
            
            log('Starting automatic navigation test...');
            updateStatus('Test running');
            
            // Start test with 2 second intervals
            testInterval = setInterval(performNavigation, 2000);
            
            document.getElementById('startTest').disabled = true;
            document.getElementById('stopTest').disabled = false;
        }
        
        function stopTest() {
            testRunning = false;
            
            if (testInterval) {
                clearInterval(testInterval);
                testInterval = null;
            }
            
            log('Test stopped');
            updateStatus('Test stopped');
            
            document.getElementById('startTest').disabled = false;
            document.getElementById('stopTest').disabled = true;
        }
        
        // Event listeners
        document.getElementById('startTest').addEventListener('click', startTest);
        document.getElementById('stopTest').addEventListener('click', stopTest);
        
        // HTMX event monitoring
        htmx.on('htmx:beforeRequest', function(evt) {
            log('HTMX request starting...');
        });
        
        htmx.on('htmx:afterRequest', function(evt) {
            log('HTMX request completed');
        });
        
        htmx.on('htmx:timeout', function(evt) {
            log('HTMX request timeout!');
            stopTest();
        });
        
        htmx.on('htmx:responseError', function(evt) {
            log('HTMX response error!');
            stopTest();
        });
        
        // Initial state
        updateStatus('Ready to test');
        document.getElementById('stopTest').disabled = true;
    </script>
</body>
</html>
