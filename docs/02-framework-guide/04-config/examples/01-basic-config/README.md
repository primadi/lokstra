# Example 01 - Basic Configuration

Simple single-file YAML configuration demonstrating core concepts.

## What's Demonstrated

- âœ… Single-file YAML configuration
- âœ… Service registration with @EndpointService annotation
- âœ… Dependency injection (service â†’ repository)
- âœ… Router auto-generation from published services
- âœ… Middleware registration and usage
- âœ… In-memory repository implementation
- âœ… Complete runnable example

## File Structure

```
01-basic-config/
â”œâ”€â”€ main.go              # Application entry point + registration
â”œâ”€â”€ user_service.go      # Service with @EndpointService annotation
â”œâ”€â”€ user_repository.go   # Repository implementation
â”œâ”€â”€ middleware.go        # Custom middleware
â”œâ”€â”€ config.yaml          # YAML configuration
â”œâ”€â”€ go.mod               # Go module file
â”œâ”€â”€ test.http            # HTTP tests
â”œâ”€â”€ README.md            # This file
â””â”€â”€ zz_generated.lokstra.go  # Auto-generated by lokstra.Bootstrap()
```

## Code Walkthrough

### 1. Service with @EndpointService Annotation

**user_service.go:**
```go
// @EndpointService name="user-service", prefix="/api/users", middlewares=["recovery", "request-logger"]
type UserService struct {
    // @Inject "user-repository"
    UserRepo UserRepository
}

// @Route "GET /{id}"
func (s *UserService) GetByID(p *GetUserRequest) (*User, error) {
    return s.UserRepo.GetByID(p.ID)
}

// @Route "GET /"
func (s *UserService) List(p *ListUsersRequest) ([]*User, error) {
    return s.UserRepo.List()
}

// @Route "POST /"
func (s *UserService) Create(p *CreateUserRequest) (*User, error) {
    // ...
}
```

**Annotations explained:**
- `@EndpointService` - Marks this as a service with auto-generated router
  - `name` - Service name for registration
  - `prefix` - URL prefix for all routes
  - `middlewares` - Middleware applied to all routes
- `@Inject` - Declares dependency injection
- `@Route` - Defines HTTP method and path for each handler

### 2. Repository Factory

**user_repository.go:**
```go
func NewUserRepository(deps map[string]any, config map[string]any) any {
    repo := &UserRepositoryImpl{
        users:  make(map[int]*User),
        nextID: 1,
    }
    // Seed data
    repo.Create(&User{Name: "John Doe", Email: "john@example.com"})
    return repo
}
```

Service factory signature: `func(deps, config map[string]any) any`

### 3. Main Registration Flow

**main.go:**
```go
func main() {
    // STEP 1: Bootstrap - generates code from annotations
    lokstra.Bootstrap()

    // STEP 2: Load Config - loads YAML configuration
    lokstra_registry.LoadConfig("config.yaml")

    // STEP 3: Register Service Types - map factory names to functions
    registerServiceTypes()

    // STEP 4: Register Middleware Types
    registerMiddlewareTypes()

    // STEP 5: Initialize and Run Server
    lokstra.InitAndRunServer()
}
```

### 4. YAML Configuration

**config.yaml:**
```yaml
deployments:
  development:
    servers:
      api:
        base-url: "http://localhost"
        addr: ":8080"
        published-services: [user-service]
```

**Minimal config! Everything else comes from:**
- `@EndpointService` annotation (service metadata)
- Service type registration in code
- Convention over configuration

## How It Works

### Bootstrap Flow

1. **`lokstra.Bootstrap()`** scans for `@EndpointService` annotations
2. Generates `zz_generated.lokstra.go` with service metadata
3. Auto-registers service type: `user-service` â†’ `UserServiceFactory`

### Service Registration Flow

1. **Repository factory registered:**
   ```go
   RegisterServiceType("user-repository-factory", NewUserRepository, nil)
   RegisterLazyService("user-repository", "user-repository-factory", nil)
   ```

2. **Service factory auto-registered** by `lokstra.Bootstrap()`:
   - Service name: `user-service`
   - Dependencies: `user-repository` (from `@Inject`)
   - Router metadata: prefix, middlewares, routes

### Router Auto-Generation

When `published-services: [user-service]` is declared:

1. Lokstra looks up `user-service` metadata
2. Creates router with prefix `/api/users`
3. Registers routes from `@Route` annotations:
   - `GET /{id}` â†’ `GetByID`
   - `GET /` â†’ `List`
   - `POST /` â†’ `Create`
4. Applies middlewares: `recovery`, `request-logger`

## Run

```bash
# Install dependencies
go mod download

# Run the application
go run .
```

**First run** will generate `zz_generated.lokstra.go`

## Test

```bash
# Get all users
curl http://localhost:8080/api/users

# Get user by ID
curl http://localhost:8080/api/users/1

# Create new user
curl -X POST http://localhost:8080/api/users \
  -H "Content-Type: application/json" \
  -d '{"name":"Bob","email":"bob@example.com"}'
```

Or use the **test.http** file in VS Code with REST Client extension.

## Generated Routes

```
GET    /api/users          # List all users
GET    /api/users/{id}     # Get user by ID
POST   /api/users          # Create new user
```

All routes have these middleware applied:
1. `recovery` - Panic recovery
2. `request-logger` - Request/response logging

## Key Concepts

### 1. Convention Over Configuration
Minimal YAML config because:
- Routes defined by `@Route` annotations
- Service metadata from `@EndpointService`
- Dependencies from `@Inject`

### 2. Auto-Generation
`lokstra.Bootstrap()` generates:
- Service factory registration
- Route metadata
- Dependency injection setup

### 3. Factory Pattern
Services and repositories use factory functions:
```go
func Factory(deps map[string]any, config map[string]any) any {
    return &Implementation{}
}
```

### 4. Dependency Injection
```go
// In annotation
// @Inject "user-repository"
UserRepo UserRepository

// Runtime resolution (automatic)
service.UserRepo = deps["user-repository"].(UserRepository)
```

## Next Steps

- See [02-multi-file](../02-multi-file/) for environment-specific configs
- See [06-handlers](../06-handlers/) for reverse proxy, SPA, static files
- See [07-db-pools](../07-db-pools/) for database configuration

## Summary

This example demonstrates:
- âœ… Annotation-driven service development
- âœ… Minimal YAML configuration
- âœ… Auto-generated routers
- âœ… Dependency injection
- âœ… Custom middleware
- âœ… Complete runnable project

All with **just one config file** and **annotations**! ðŸŽ‰
